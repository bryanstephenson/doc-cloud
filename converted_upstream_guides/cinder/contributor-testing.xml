<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Testing</title>
  <para>Cinder contains a few different test suites in the cinder/tests/ directory. The
            different test suites are Unit Tests, Functional Tests, and Tempest Tests.</para>
  <section>
    <title>Test Types</title>
    <section>
      <title>Unit Tests</title>
      <para>Unit tests are tests for individual methods, with at most a small handful of
                    modules involved. Mock should be used to remove any external dependencies.</para>
      <para>All significant code changes should have unit test coverage validating the code
                    happy path and any failure paths.</para>
      <para>Any proposed code change will be automatically rejected by the OpenStack
                    Jenkins server  if the change causes unit test failures.</para>
    </section>
    <section>
      <title>Functional Tests</title>
      <para>Functional tests validate a code path within Cinder. These tests should
                    validate the interaction of various modules within the project to verify the
                    code is logically correct.</para>
      <para>Functional tests run with a database present and may start Cinder services to
                    accept requests. These tests should not need to access an other OpenStack
                    non-Cinder services.</para>
    </section>
    <section>
      <title>Tempest Tests</title>
      <para>The tempest tests in the Cinder tree validate the operational correctness
                    between Cinder and external components such as Nova, Glance, etc. These are
                    integration tests driven via public APIs to verify actual end user usage
                    scenarios.</para>
    </section>
  </section>
  <section>
    <title>Running the tests</title>
    <para>There are a number of ways to run tests currently, and there’s a combination of
                frameworks used depending on what commands you use. The preferred method is to
                use tox, which calls ostestr via the tox.ini file.</para>
    <section>
      <title>Unit Tests</title>
      <para>To run all unit tests simply run:</para>
      <screen>tox</screen>
      <para>This will create a virtual environment, load all the packages from
                    test-requirements.txt and run all unit tests as well as run flake8 and hacking
                    checks against the code.</para>
      <para>You may run individual test targets, for example only py27 tests, by running:</para>
      <screen>tox -e py27</screen>
      <para>Note that you can inspect the tox.ini file to get more details on the available
                    options and what the test run does by default.</para>
    </section>
    <section>
      <title>Functional Tests</title>
      <para>To run all functional tests, run:</para>
      <screen>tox -e functional</screen>
    </section>
    <section>
      <title>Tempest Tests</title>
      <para>Tempest tests in the Cinder tree are “plugged in” to the normal tempest test
                    execution. To ensure the Cinder tests are picked up when running tempest, run:</para>
      <screen>cd /opt/stack/tempest
tox -e all-plugin</screen>
      <para>More information about tempest can be found in the <link xlink:href="http://docs.openstack.org/developer/tempest/overview.html">Tempest Documentation</link>.</para>
    </section>
    <section>
      <title>Database Setup</title>
      <para>Some unit and functional tests will use a local database. You can use
                    <literal>tools/test-setup.sh</literal> to set up your local system the same way as
                    it’s setup in the CI environment.</para>
    </section>
  </section>
  <section>
    <title>Running a subset of tests using tox</title>
    <para>One common activity is to just run a single test, you can do this with tox
                simply by specifying to just run py27 or py35 tests against a single test:</para>
    <screen><?dbsuse-fo font-size="8pt"?>tox -epy27 -- -n cinder.tests.unit.test_volume.AvailabilityZoneTestCase.test_list_availability_zones_cached</screen>
    <para>Or all tests in the test_volume.py file:</para>
    <screen>tox -epy27 -- -n cinder.tests.unit.test_volume</screen>
    <para>You may also use regular expressions to run any matching tests:</para>
    <screen>tox -epy27 -- -r test_volume</screen>
    <para>For more information on these options and how to run tests, please see the
                <link xlink:href="http://docs.openstack.org/developer/os-testr/">ostestr documentation</link>.</para>
  </section>
  <section>
    <title>Gotchas</title>
    <para>
      <emphasis role="bold">Running Tests from Shared Folders</emphasis>
    </para>
    <para>If you are running the unit tests from a shared folder, you may see tests start
                to fail or stop completely as a result of Python lockfile issues. You
                can get around this by manually setting or updating the following line in
                <literal>cinder/tests/conf_fixture.py</literal>:</para>
    <screen>CONF['lock_path'].SetDefault('/tmp')</screen>
    <para>Note that you may use any location (not just <literal>/tmp</literal>!) as long as it is not
                a shared folder.</para>
    <para>
      <emphasis role="bold">Running py35 tests</emphasis>
    </para>
    <para>You will need to install python3-dev in order to get py35 tests to run. If you
                do not have this, you will get the following:</para>
    <screen><?dbsuse-fo font-size="8pt"?>netifaces.c:1:20: fatal error: Python.h: No such file or directory
    #include &lt;Python.h&gt;
            ^
    compilation terminated.
    error: command 'x86_64-linux-gnu-gcc' failed with exit status 1

    ----------------------------------------
    &lt;snip&gt;
ERROR: could not install deps [-r/opt/stack/cinder/test-requirements.txt,
    oslo.versionedobjects[fixtures]]; v = InvocationError('/opt/stack/cinder/
    .tox/py35/bin/pip install -r/opt/stack/cinder/test-requirements.txt
    oslo.versionedobjects[fixtures] (see /opt/stack/cinder/.tox/py35/log/py35-1.log)', 1)
_______________________________________________________________ summary _______________________________________________________________
ERROR:   py35: could not install deps [-r/opt/stack/cinder/test-requirements.txt,
    oslo.versionedobjects[fixtures]]; v = InvocationError('/opt/stack/cinder/
    .tox/py35/bin/pip install -r/opt/stack/cinder/test-requirements.txt
    oslo.versionedobjects[fixtures] (see /opt/stack/cinder/.tox/py35/log/py35-1.log)', 1)</screen>
    <para>To Fix:</para>
    <itemizedlist>
      <listitem>
        <para>On Ubuntu/Debian:</para>
        <screen>sudo apt-get install python3-dev</screen>
      </listitem>
      <listitem>
        <para>On Fedora 21/RHEL7/CentOS7:</para>
        <screen>sudo yum install python3-devel</screen>
      </listitem>
      <listitem>
        <para>On Fedora 22 and higher:</para>
        <screen>sudo dnf install python3-devel</screen>
      </listitem>
    </itemizedlist>
  </section>
</section>
