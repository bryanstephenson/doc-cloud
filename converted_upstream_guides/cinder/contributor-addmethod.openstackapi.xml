<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook">
  <title>Adding a Method to the OpenStack API</title>
  <para>The interface is a mostly RESTful API. REST stands for Representational State Transfer and provides an architecture “style” for distributed systems using HTTP for transport. Figure out a way to express your request and response in terms of resources that are being created, modified, read, or destroyed.</para>
  <section>
    <title>Routing</title>
    <para>To map URLs to controllers+actions, OpenStack uses the Routes package, a clone of Rails routes for Python implementations. See <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://routes.groovie.org/"/> for more information.</para>
    <para>URLs are mapped to “action” methods on “controller” classes in <literal>cinder/api/openstack/__init__/ApiRouter.__init__</literal> .</para>
    <variablelist>
      <varlistentry>
        <term>See <link xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="http://routes.groovie.org/manual.html"/> for all syntax, but you’ll probably just need these two:</term>
        <listitem>
          <itemizedlist>
            <listitem>
              <para>mapper.connect() lets you map a single URL to a single action on a controller.</para>
            </listitem>
            <listitem>
              <para>mapper.resource() connects many standard URLs to actions on a controller.</para>
            </listitem>
          </itemizedlist>
        </listitem>
      </varlistentry>
    </variablelist>
  </section>
  <section>
    <title>Controllers and actions</title>
    <para>Controllers live in <literal>cinder/api/openstack</literal>, and inherit from cinder.wsgi.Controller.</para>
    <para>See <literal>cinder/api/v2/volumes.py</literal> for an example.</para>
    <para>Action methods take parameters that are sucked out of the URL by mapper.connect() or .resource().  The first two parameters are self and the WebOb request, from which you can get the req.environ, req.body, req.headers, etc.</para>
  </section>
  <section>
    <title>Serialization</title>
    <para>Actions return a dictionary, and wsgi.Controller serializes that to JSON or XML based on the request’s content-type.</para>
  </section>
  <section>
    <title>Errors</title>
    <para>There will be occasions when you will want to return a REST error response to
                the caller and there are multiple valid ways to do this:</para>
    <itemizedlist>
      <listitem>
        <para>If you are at the controller level you can use a <literal>faults.Fault</literal> instance to
                        indicate the error.  You can either return the <literal>Fault</literal> instance as the
                        result of the action, or raise it, depending on what’s more convenient:
                        <literal>raise faults.Fault(webob.exc.HTTPBadRequest(explanation=msg))</literal>.</para>
      </listitem>
      <listitem>
        <para>If you are raising an exception our WSGI middleware exception handler is
                        smart enough to recognize webob exceptions as well, so you don’t really need
                        to wrap the exceptions in a <literal>Fault</literal> class and you can just let the
                        middleware add it for you:
                        <literal>raise webob.exc.HTTPBadRequest(explanation=msg)</literal>.</para>
      </listitem>
      <listitem>
        <para>While most errors require an explicit webob exception there are some Cinder
                        exceptions (<literal>NotFound</literal> and <literal>Invalid</literal>) that are so common that they are
                        directly handled by the middleware and don’t need us to convert them, we can
                        just raise them at any point in the API service and they will return the
                        appropriate REST error to the caller.  So any <literal>NotFound</literal> exception, or
                        child class, will return a 404 error, and any <literal>Invalid</literal> exception, or
                        child class, will return a 400 error.</para>
      </listitem>
    </itemizedlist>
  </section>
</section>
