<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Services, Managers and Drivers</title>
  <para>The responsibilities of Services, Managers, and Drivers, can be a bit confusing to people that are new to cinder.  This document attempts to outline the division of responsibilities to make understanding the system a little bit easier.</para>
  <para>Currently, Managers and Drivers are specified by flags and loaded using utils.load_object().  This method allows for them to be implemented as singletons, classes, modules or objects.  As long as the path specified by the flag leads to an object (or a callable that returns an object) that responds to getattr, it should work as a manager or driver.</para>
  <section>
    <title>The <xref linkend="module-cinder.service"/> Module</title>
    <para>Generic Node base class for all workers that run on hosts.</para>
    <variablelist>
      <varlistentry>
        <term>
          <literal/>
        </term>
        <listitem>
          <para>Bases: <literal>object</literal></para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>
          <literal/>
        </term>
        <listitem>
          <para>Bases: <literal>oslo_service.service.Service</literal></para>
          <para>Service object for binaries running on hosts.</para>
          <para>A service takes a manager and enables rpc by listening to queues based
                        on topic. It also periodically runs tasks on the manager and reports
                        it state to the database services table.</para>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para>Perform basic config checks before starting service.</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para>Instantiates class and passes back application object.</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para>Tasks to be run at a periodic interval.</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para>Update the state of this service in the datastore.</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para/>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para/>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para/>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para/>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para/>
              </listitem>
            </varlistentry>
          </variablelist>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>
          <literal/>
        </term>
        <listitem>
          <para>Bases: <literal>oslo_service.service.ServiceBase</literal></para>
          <para>Provides ability to launch API from a ‘paste’ configuration.</para>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para>Reset server greenpool size to default.</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para>Start serving this service using loaded configuration.</para>
                <para>Also, retrieve updated port number in case ‘0’ was passed in, which
                                indicates a random port should be used.</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para>Stop serving this API.</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para>Wait for the service to stop serving this API.</para>
              </listitem>
            </varlistentry>
          </variablelist>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>
          <function/>
        </term>
        <listitem>
          <para/>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>
          <function/>
        </term>
        <listitem>
          <para/>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>
          <function/>
        </term>
        <listitem>
          <para/>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>
          <function/>
        </term>
        <listitem>
          <para/>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>
          <function/>
        </term>
        <listitem>
          <para/>
        </listitem>
      </varlistentry>
    </variablelist>
  </section>
  <section>
    <title>The <xref linkend="module-cinder.manager"/> Module</title>
    <para>Base Manager class.</para>
    <para>Managers are responsible for a certain aspect of the system.  It is a logical
                grouping of code relating to a portion of the system.  In general other
                components should be using the manager to make changes to the components that
                it is responsible for.</para>
    <para>For example, other components that need to deal with volumes in some way,
                should do so by calling methods on the VolumeManager instead of directly
                changing fields in the database.  This allows us to keep all of the code
                relating to volumes in the same place.</para>
    <para>We have adopted a basic strategy of Smart managers and dumb data, which means
                rather than attaching methods to data objects, components should call manager
                methods that act on the data.</para>
    <para>Methods on managers that can be executed locally should be called directly. If
                a particular method must execute on a remote host, this should be done via rpc
                to the service that wraps the manager</para>
    <para>Managers should be responsible for most of the db access, and
                non-implementation specific data.  Anything implementation specific that can’t
                be generalized should be done by the Driver.</para>
    <para>In general, we prefer to have one manager with multiple drivers for different
                implementations, but sometimes it makes sense to have multiple managers.  You
                can think of it this way: Abstract different overall strategies at the manager
                level(FlatNetwork vs VlanNetwork), and different implementations at the driver
                level(LinuxNetDriver vs CiscoNetDriver).</para>
    <para>Managers will often provide methods for initial setup of a host or periodic
                tasks to a wrapping service.</para>
    <para>This module provides Manager, a base class for managers.</para>
    <variablelist>
      <varlistentry>
        <term>
          <literal/>
        </term>
        <listitem>
          <para>Bases: <literal>object</literal></para>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para/>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para/>
              </listitem>
            </varlistentry>
          </variablelist>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>
          <literal/>
        </term>
        <listitem>
          <para>Bases: <xref linkend="cinder.db.base.Base"/>, <xref linkend="cinder.manager.PeriodicTasks"/></para>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para/>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para/>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para>Handle initialization if this is a standalone service.</para>
                <para>A hook point for services to execute tasks before the services are made
                                available (i.e. showing up on RPC and starting to accept RPC calls) to
                                other components.  Child classes should override this method.</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para>A hook for service to do jobs after RPC is ready.</para>
                <para>Like init_host(), this method is a hook where services get a chance
                                to execute tasks that <emphasis>need</emphasis> RPC. Child classes should override
                                this method.</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para>Method indicating if service is working correctly.</para>
                <para>This method is supposed to be overridden by subclasses and return if
                                manager is working correctly.</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para>Method executed when SIGHUP is caught by the process.</para>
                <para>We’re utilizing it to reset RPC API version pins to avoid restart of
                                the service when rolling upgrade is completed.</para>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para/>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para/>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para/>
              </listitem>
            </varlistentry>
          </variablelist>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>
          <literal/>
        </term>
        <listitem>
          <para>Bases: <literal>oslo_service.periodic_task.PeriodicTasks</literal></para>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>
          <literal/>
        </term>
        <listitem>
          <para>Bases: <xref linkend="cinder.manager.ThreadPoolManager"/></para>
          <para>Periodically send capability updates to the Scheduler services.</para>
          <para>Services that need to update the Scheduler of their capabilities
                        should derive from this class. Otherwise they can derive from
                        manager.Manager directly. Updates are only sent after
                        update_service_capabilities is called with non-None values.</para>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para/>
              </listitem>
            </varlistentry>
          </variablelist>
          <variablelist>
            <varlistentry>
              <term>
                <property/>
              </term>
              <listitem>
                <para>Remember these capabilities to send on next periodic update.</para>
              </listitem>
            </varlistentry>
          </variablelist>
        </listitem>
      </varlistentry>
    </variablelist>
    <variablelist>
      <varlistentry>
        <term>
          <literal/>
        </term>
        <listitem>
          <para>Bases: <xref linkend="cinder.manager.Manager"/></para>
        </listitem>
      </varlistentry>
    </variablelist>
  </section>
  <section>
    <title>Implementation-Specific Drivers</title>
    <para>A manager will generally load a driver for some of its tasks. The driver is responsible for specific implementation details.  Anything running shell commands on a host, or dealing with other non-python code should probably be happening in a driver.</para>
    <para>Drivers should minimize touching the database, although it is currently acceptable for implementation specific data. This may be reconsidered at some point.</para>
    <para>It usually makes sense to define an Abstract Base Class for the specific driver (i.e. VolumeDriver), to define the methods that a different driver would need to implement.</para>
  </section>
</section>
