<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<section xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:xi="http://www.w3.org/2001/XInclude" version="5.1">
  <title>Translation in Horizon</title>
  <section>
    <title>What is the point of translating my code?</title>
    <para>You introduced an awesome piece of code and revel in your glorious
                accomplishment. Suddenly your world comes crashing down when a core hands you
                a -1 because your code is not translated. What gives?</para>
    <para>If you are writing software for a global audience, you must ensure that it is
                translated so that other people around the world are able to use it. Adding
                translation to your code is not that hard and a requirement for horizon.</para>
    <para>If you are interested in contributing translations, you may want to investigate
                <link xlink:href="https://translate.openstack.org">Zanata</link> and the
                <link xlink:href="https://docs.openstack.org/i18n/latest/">upstream translations</link>.
                You can visit the internationalization project IRC channel <emphasis role="bold">#openstack-i18n</emphasis>,
                if you need further assistance.</para>
  </section>
  <section>
    <title>Overview and Architecture</title>
    <para>You can skip this section if you are only interested in learning how to use
                translation. This section explains the two main components to translation:
                message extraction and message substitution. We will briefly go over what each
                one does for translation as a whole.</para>
    <section>
      <title>Message Extraction</title>
      <figure>
        <title/>
        <informalfigure>
          <mediaobject>
            <imageobject role="fo">
              <imagedata fileref="message_extraction.png" width="80%"/>
            </imageobject>
            <imageobject role="html">
              <imagedata fileref="message_extraction.png" width="80%"/>
            </imageobject>
          </mediaobject>
        </informalfigure>
      </figure>
      <para>Message extraction is the process of collecting translatable strings from the
                    code. The diagram above shows the flow of how messages are extracted and then
                    translated. Lets break this up into steps we can follow:</para>
      <procedure>
        <step>
          <para>The first step is to mark untranslated strings so that the extractor is able
                            to locate them. Refer to the guide below on how to use translation and what
                            these markers look like.</para>
        </step>
        <step>
          <para>Once marked, we can then run <literal>tox -e manage -- extract_messages</literal>, which
                            searches the codebase for these markers and extracts them into a Portable
                            Object Template (POT) file. In horizon, we extract from both the <literal>horizon</literal>
                            folder and the <literal>openstack_dashboard</literal> folder. We use the AngularJS extractor
                            for JavaScript and HTML files and the Django extractor for Python and Django
                            templates; both extractors are Babel plugins.</para>
        </step>
        <step>
          <para>To update the .po files, you can run <literal>tox -e manage -- update_catalog</literal> to
                            update the .po file for every language, or you can specify a specific
                            language to update like this: <literal>tox -e manage -- update_catalog de</literal>. This
                            is useful if you want to add a few extra translatabale strings for a
                            downstream customisation.</para>
        </step>
      </procedure>
      <note>
        <para>When pushing code upstream, the only requirement is to mark the strings
                        correctly. All creation of POT and PO files is handled by a daily upstream
                        job. Further information can be found in the
                        <link xlink:href="https://docs.openstack.org/i18n/latest/infra.html">translation infrastructure documentation</link>.</para>
      </note>
    </section>
    <section>
      <title>Message Substitution</title>
      <figure>
        <title/>
        <informalfigure>
          <mediaobject>
            <imageobject role="fo">
              <imagedata fileref="message_substitution.png" width="80%"/>
            </imageobject>
            <imageobject role="html">
              <imagedata fileref="message_substitution.png" width="80%"/>
            </imageobject>
          </mediaobject>
        </informalfigure>
      </figure>
      <para>Message substitution is not the reverse process of message extraction. The
                    process is entirely different. Lets walk through this process.</para>
      <itemizedlist>
        <listitem>
          <para>Remember those markers we talked about earlier? Most of them are functions
                            like gettext or one of its variants. This allows the function to serve a dual
                            purpose - acting as a marker and also as a replacer.</para>
        </listitem>
        <listitem>
          <para>In order for translation to work properly, we need to know the user’s locale.
                            In horizon, the user can specify the locale using the Settings panel. Once we
                            know the locale, we know which Portable Object (PO) file to use. The PO file
                            is the file we received from translators in the message extraction process.
                            The gettext functions that we wrapped our code around are then able to
                            replace the untranslated strings with the translated one by using the
                            untranslated string as the message id.</para>
        </listitem>
        <listitem>
          <para>For client-side translation, Django embeds a corresponding Django message
                            catalog. Javascript code on the client can use this catalog to do string
                            replacement similar to how server-side translation works.</para>
        </listitem>
      </itemizedlist>
      <para>If you are setting up a project and need to know how to make it translatable,
                    please refer to <link xlink:href="https://docs.openstack.org/infra/manual/creators.html#enabling-translation-infrastructure">this guide</link>.</para>
    </section>
  </section>
  <section xml:id="making-strings-translatable">
    <title>Making strings translatable</title>
    <para>To make your strings translatable, you need to mark it so that horizon can
                locate and extract it into a POT file. When a user from another locale visits
                your page, your string is replaced with the correct translated version.</para>
    <section>
      <title>In Django</title>
      <para>To translate a string, simply wrap one of the gettext variants around the
                    string. The examples below show you how to do translation for various
                    scenarios, such as interpolation, contextual markers and translation comments.</para>
      <screen>from django.utils.translation import pgettext
from django.utils.translation import ugettext as _
from django.utils.translation import ungettext


class IndexView(request):

    # Single example
    _("Images")

    # Plural example
    ungettext(
        'there is %(count)d object',
        'there are %(count)d objects',
        count) % { 'count': count }

    # Interpolated example
    mood = ‘wonderful’
    output = _('Today is %(mood)s.') % mood

    # Contextual markers
    pgettext("the month name", "May")

    # Translators: This message appears as a comment for translators!
    ugettext("Welcome translators.")</screen>
      <note>
        <para>In the example above, we imported <literal>ugettext</literal> as <literal>_</literal>. This is a common
                        alias for gettext or any of its variants. In Django, you have to explicitly
                        spell it out with the import statement.</para>
      </note>
    </section>
    <section>
      <title>In Django templates</title>
      <para>To use translation in your template, make sure you load the i18n module. To
                    translate a line of text, use the <literal>trans</literal> template tag. If you need to
                    translate a block of text, use the <literal>blocktrans</literal> template tag.</para>
      <para>Sometimes, it is helpful to provide some context via the <literal>comment</literal> template
                    tag. There a number of other tags and filters at your disposal should you need
                    to use them. For more information, see the
                    <link xlink:href="https://docs.djangoproject.com/en/1.8/topics/i18n/translation/">Django docs</link></para>
      <screen>{% extends 'base.html' %}
{% load i18n %}
{% block title %}
  {% trans "Images" %}
{% endblock %}

{% block main %}
  {% comment %}Translators: Images is an OpenStack resource{% endcomment %}
  {% blocktrans with amount=images.length %}
    There are {{ amount }} images available for display.
  {% endblocktrans %}
{% endblock %}</screen>
    </section>
    <section>
      <title>In JavaScript</title>
      <para>The Django message catalog is injected into the front-end. The gettext function
                    is available as a global function so you can just use it directly. If you are
                    writing AngularJS code, we prefer that you use the gettext service, which is
                    essentially a wrapper around the gettext function.</para>
      <screen>Angular
  .module(…)
  .controller(myCtrl);

myCtrl.$inject = [‘horizon.framework.util.i18n.gettext’];
function myCtrl(gettext) {
  var translated = gettext(‘Images’);
}</screen>
      <warning>
        <para>For localization in AngularJS files, use the
                        AngularJS service <literal>horizon.framework.util.i18n.gettext</literal>. Ensure that the
                        injected dependency is named <literal>gettext</literal> or <literal>nggettext</literal>. If you do not do this,
                        message extraction will not work properly!</para>
      </warning>
    </section>
    <section>
      <title>In AngularJS templates</title>
      <para>To use translation in your AngularJS template, use the translate tag or the
                    translate filter. Note that we are using
                    <link xlink:href="https://angular-gettext.rocketeer.be/">angular-gettext</link>
                    for message substitution but not for message extraction.</para>
      <screen>&lt;translate&gt;Directive example&lt;/translate&gt;
&lt;div translate&gt;Attribute example&lt;/div&gt;
&lt;div translate&gt;Interpolated {{example}}&lt;/div&gt;
&lt;span&gt;{$ ‘Filter example’|translate $}&lt;/span&gt;

&lt;span translate&gt;
  This &lt;em&gt;is&lt;/em&gt; a &lt;strong&gt;bad&lt;/strong&gt; example
  because it contains HTML and makes it harder to translate.
  However, it will still translate.
&lt;/span&gt;</screen>
      <note>
        <para>The annotations in the example above are guaranteed to work. However, not all of
                        the angular-gettext annotations are supported because we wrote our own custom
                        babel extractor. If you need support for the annotations, ask on IRC in the
                        #openstack-horizon room or report a bug. Also note that you should avoid embedding
                        HTML fragments in your texts because it makes it harder to translate. Use your
                        best judgement if you absolutely need to include HTML.</para>
      </note>
    </section>
  </section>
  <section xml:id="pseudo-translation">
    <title>Pseudo translation tool</title>
    <para>The pseudo translation tool can be used to verify that code is ready to be
                translated. The pseudo tool replaces a language’s translation with a complete,
                fake translation. Then you can verify that your code properly displays fake
                translations to validate that your code is ready for translation.</para>
    <section>
      <title>Running the pseudo translation tool</title>
      <procedure>
        <step>
          <para>Make sure your .pot files are up to date:
                            <literal>tox -e manage -- extract_messages</literal></para>
        </step>
        <step>
          <para>Run the pseudo tool to create pseudo translations. For example, to replace
                            the German translation with a pseudo translation:
                            <literal>tox -e manage -- update_catalog de --pseudo</literal></para>
        </step>
        <step>
          <para>Compile the catalog: <literal>tox -e manage -- compilemessages</literal></para>
        </step>
        <step>
          <para>Run your development server.</para>
        </step>
        <step>
          <para>Log in and change to the language you pseudo translated.</para>
        </step>
      </procedure>
      <para>It should look weird. More specifically, the translatable segments are going
                    to start and end with a bracket and they are going to have some added
                    characters. For example, “Log In” will become “[~Log In~您好яшçあ]”
                    This is useful because you can inspect for the following, and consider if your
                    code is working like it should:</para>
      <itemizedlist>
        <listitem>
          <para>If you see a string in English it’s not translatable. Should it be?</para>
        </listitem>
        <listitem>
          <para>If you see brackets next to each other that might be concatenation. Concatenation
                            can make quality translations difficult or impossible. See
                            <link xlink:href="https://wiki.openstack.org/wiki/I18n/TranslatableStrings#Use_string_formating_variables.2C_never_perform_string_concatenation">“Use string formatting variables, never perform string concatenation”</link>
                            for additional information.</para>
        </listitem>
        <listitem>
          <para>If there is unexpected wrapping/truncation there might not be enough
                            space for translations.</para>
        </listitem>
        <listitem>
          <para>If you see a string in the proper translated language, it comes from an
                            external source. (That’s not bad, just sometimes useful to know)</para>
        </listitem>
        <listitem>
          <para>If you get new crashes, there is probably a bug.</para>
        </listitem>
      </itemizedlist>
      <para>Don’t forget to remove any pseudo translated <literal>.pot</literal> or <literal>.po</literal> files.
                    Those should not be submitted for review.</para>
    </section>
  </section>
</section>
